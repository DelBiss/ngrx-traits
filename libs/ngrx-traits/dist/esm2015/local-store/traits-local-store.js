import { Injectable, Injector } from '@angular/core';
import { createFeatureSelector, ReducerManager, Store } from '@ngrx/store';
import { EffectSources } from '@ngrx/effects';
import { getDestroyActionName } from '../trait-effect';
let id = 0;
function uniqueComponentId() {
  return id++;
}
export function buildLocalTraits(
  injector,
  componentName,
  traitFactory,
  fetchEffectFactory
) {
  var _a;
  const reducers = injector.get(ReducerManager);
  const effects = injector.get(EffectSources);
  const store = injector.get(Store);
  const componentId = `${componentName}_${uniqueComponentId()}`;
  const traits = traitFactory({
    featureSelector: createFeatureSelector(componentId),
    actionsGroupKey: `[${componentId}]`,
  });
  traits.reducer && reducers.addReducer(componentId, traits.reducer);
  const fetchEffect =
    fetchEffectFactory === null || fetchEffectFactory === void 0
      ? void 0
      : fetchEffectFactory(traits.actions, traits.selectors);
  const providers =
    (traits.effects && [...traits.effects.map((e) => ({ provide: e }))]) || [];
  if (fetchEffect) {
    providers.push({ provide: fetchEffect });
  }
  const i = Injector.create({
    providers: providers,
    parent: injector,
  });
  (_a = traits.effects) === null || _a === void 0
    ? void 0
    : _a.forEach((e) => {
        const effect = i.get(e);
        effect.componentId = componentId;
        effects.addEffects(effect);
      });
  if (fetchEffectFactory) {
    const effect = i.get(fetchEffect);
    effect.componentId = componentId;
    effects.addEffects(effect);
  }
  function destroy() {
    store.dispatch({ type: getDestroyActionName(componentId) });
    /**
     * A service that extends TraitsLocalStore and other component service are destroyed
     * before the component that depends on them, this causes that any subscriptions
     * to selectors of the TraitsLocalStore could fail because the store state is removed before
     * they are unsubscribe by the onDestroy of the component. Executing reducers.removeReducer
     * inside setTimeout ensures the state is remove after the component onDestroy was called,
     * avoiding the before mentioned possible issues.
     */
    setTimeout(() => reducers.removeReducer(componentId));
  }
  return Object.assign({ destroy }, traits);
}
export class TraitsLocalStore {
  constructor(injector) {
    this.injector = injector;
    const config = this.setup();
    this.traits = buildLocalTraits(
      this.injector,
      config.componentName,
      config.traitsFactory,
      config.effectFactory
    );
    this.actions = this.traits.actions;
    this.selectors = this.traits.selectors;
  }
  ngOnDestroy() {
    this.traits.destroy();
  }
}
TraitsLocalStore.decorators = [{ type: Injectable }];
TraitsLocalStore.ctorParameters = () => [{ type: Injector }];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhaXRzLWxvY2FsLXN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9sb2NhbC1zdG9yZS90cmFpdHMtbG9jYWwtc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDM0UsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM5QyxPQUFPLEVBQUUsb0JBQW9CLEVBQWUsTUFBTSxpQkFBaUIsQ0FBQztBQUVwRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDWCxTQUFTLGlCQUFpQjtJQUN4QixPQUFPLEVBQUUsRUFBRSxDQUFDO0FBQ2QsQ0FBQztBQUVELE1BQU0sVUFBVSxnQkFBZ0IsQ0FJOUIsUUFBa0IsRUFDbEIsYUFBcUIsRUFDckIsWUFBZSxFQUNmLGtCQUFnRDs7SUFFaEQsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUM5QyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzVDLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEMsTUFBTSxXQUFXLEdBQUcsR0FBRyxhQUFhLElBQUksaUJBQWlCLEVBQUUsRUFBRSxDQUFDO0lBRTlELE1BQU0sTUFBTSxHQUFHLFlBQVksQ0FBQztRQUMxQixlQUFlLEVBQUUscUJBQXFCLENBQVEsV0FBVyxDQUFDO1FBQzFELGVBQWUsRUFBRSxJQUFJLFdBQVcsR0FBRztLQUNwQyxDQUFrQixDQUFDO0lBRXBCLE1BQU0sQ0FBQyxPQUFPLElBQUksUUFBUSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRW5FLE1BQU0sV0FBVyxHQUFHLGtCQUFrQixhQUFsQixrQkFBa0IsdUJBQWxCLGtCQUFrQixDQUFHLE1BQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRTNFLE1BQU0sU0FBUyxHQUNiLENBQUMsTUFBTSxDQUFDLE9BQU8sSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDN0UsSUFBSSxXQUFXLEVBQUU7UUFDZixTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7S0FDMUM7SUFFRCxNQUFNLENBQUMsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDO1FBQ3hCLFNBQVMsRUFBRSxTQUFTO1FBQ3BCLE1BQU0sRUFBRSxRQUFRO0tBQ2pCLENBQUMsQ0FBQztJQUVILE1BQUEsTUFBTSxDQUFDLE9BQU8sMENBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7UUFDNUIsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQWdCLENBQUM7UUFDdkMsTUFBTSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDakMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM3QixDQUFDLEVBQUU7SUFFSCxJQUFJLGtCQUFrQixFQUFFO1FBQ3RCLE1BQU0sTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFnQixDQUFDO1FBQ2pELE1BQU0sQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQ2pDLE9BQU8sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7S0FDNUI7SUFFRCxTQUFTLE9BQU87UUFDZCxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxFQUFFLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM1RDs7Ozs7OztXQU9HO1FBQ0gsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRUQsdUJBQ0UsT0FBTyxJQUNKLE1BQU0sRUFDVDtBQUNKLENBQUM7QUFvQkQsTUFBTSxPQUFnQixnQkFBZ0I7SUFNcEMsWUFBMEIsUUFBa0I7UUFBbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUMxQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxnQkFBZ0IsQ0FDNUIsSUFBSSxDQUFDLFFBQVEsRUFDYixNQUFNLENBQUMsYUFBYSxFQUNwQixNQUFNLENBQUMsYUFBYSxFQUNwQixNQUFNLENBQUMsYUFBYSxDQUNyQixDQUFDO1FBQ0YsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUNuQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO0lBQ3pDLENBQUM7SUFJRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUN4QixDQUFDOzs7WUF2QkYsVUFBVTs7O1lBN0ZVLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRmVhdHVyZUZhY3RvcnkgfSBmcm9tICcuLi9tb2RlbCc7XG5pbXBvcnQgeyBjcmVhdGVGZWF0dXJlU2VsZWN0b3IsIFJlZHVjZXJNYW5hZ2VyLCBTdG9yZSB9IGZyb20gJ0BuZ3J4L3N0b3JlJztcbmltcG9ydCB7IEVmZmVjdFNvdXJjZXMgfSBmcm9tICdAbmdyeC9lZmZlY3RzJztcbmltcG9ydCB7IGdldERlc3Ryb3lBY3Rpb25OYW1lLCBUcmFpdEVmZmVjdCB9IGZyb20gJy4uL3RyYWl0LWVmZmVjdCc7XG5cbmxldCBpZCA9IDA7XG5mdW5jdGlvbiB1bmlxdWVDb21wb25lbnRJZCgpIHtcbiAgcmV0dXJuIGlkKys7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZExvY2FsVHJhaXRzPFxuICBTdGF0ZSxcbiAgRiBleHRlbmRzIEZlYXR1cmVGYWN0b3J5PFN0YXRlLCBhbnksIGFueSwgYW55Pixcbj4oXG4gIGluamVjdG9yOiBJbmplY3RvcixcbiAgY29tcG9uZW50TmFtZTogc3RyaW5nLFxuICB0cmFpdEZhY3Rvcnk6IEYsXG4gIGZldGNoRWZmZWN0RmFjdG9yeT86IFRyYWl0TG9jYWxFZmZlY3RzRmFjdG9yeTxGPixcbikge1xuICBjb25zdCByZWR1Y2VycyA9IGluamVjdG9yLmdldChSZWR1Y2VyTWFuYWdlcik7XG4gIGNvbnN0IGVmZmVjdHMgPSBpbmplY3Rvci5nZXQoRWZmZWN0U291cmNlcyk7XG4gIGNvbnN0IHN0b3JlID0gaW5qZWN0b3IuZ2V0KFN0b3JlKTtcbiAgY29uc3QgY29tcG9uZW50SWQgPSBgJHtjb21wb25lbnROYW1lfV8ke3VuaXF1ZUNvbXBvbmVudElkKCl9YDtcblxuICBjb25zdCB0cmFpdHMgPSB0cmFpdEZhY3Rvcnkoe1xuICAgIGZlYXR1cmVTZWxlY3RvcjogY3JlYXRlRmVhdHVyZVNlbGVjdG9yPFN0YXRlPihjb21wb25lbnRJZCksXG4gICAgYWN0aW9uc0dyb3VwS2V5OiBgWyR7Y29tcG9uZW50SWR9XWAsXG4gIH0pIGFzIFJldHVyblR5cGU8Rj47XG5cbiAgdHJhaXRzLnJlZHVjZXIgJiYgcmVkdWNlcnMuYWRkUmVkdWNlcihjb21wb25lbnRJZCwgdHJhaXRzLnJlZHVjZXIpO1xuXG4gIGNvbnN0IGZldGNoRWZmZWN0ID0gZmV0Y2hFZmZlY3RGYWN0b3J5Py4odHJhaXRzLmFjdGlvbnMsIHRyYWl0cy5zZWxlY3RvcnMpO1xuXG4gIGNvbnN0IHByb3ZpZGVycyA9XG4gICAgKHRyYWl0cy5lZmZlY3RzICYmIFsuLi50cmFpdHMuZWZmZWN0cy5tYXAoKGUpID0+ICh7IHByb3ZpZGU6IGUgfSkpXSkgfHwgW107XG4gIGlmIChmZXRjaEVmZmVjdCkge1xuICAgIHByb3ZpZGVycy5wdXNoKHsgcHJvdmlkZTogZmV0Y2hFZmZlY3QgfSk7XG4gIH1cblxuICBjb25zdCBpID0gSW5qZWN0b3IuY3JlYXRlKHtcbiAgICBwcm92aWRlcnM6IHByb3ZpZGVycyxcbiAgICBwYXJlbnQ6IGluamVjdG9yLFxuICB9KTtcblxuICB0cmFpdHMuZWZmZWN0cz8uZm9yRWFjaCgoZSkgPT4ge1xuICAgIGNvbnN0IGVmZmVjdCA9IGkuZ2V0KGUpIGFzIFRyYWl0RWZmZWN0O1xuICAgIGVmZmVjdC5jb21wb25lbnRJZCA9IGNvbXBvbmVudElkO1xuICAgIGVmZmVjdHMuYWRkRWZmZWN0cyhlZmZlY3QpO1xuICB9KTtcblxuICBpZiAoZmV0Y2hFZmZlY3RGYWN0b3J5KSB7XG4gICAgY29uc3QgZWZmZWN0ID0gaS5nZXQoZmV0Y2hFZmZlY3QpIGFzIFRyYWl0RWZmZWN0O1xuICAgIGVmZmVjdC5jb21wb25lbnRJZCA9IGNvbXBvbmVudElkO1xuICAgIGVmZmVjdHMuYWRkRWZmZWN0cyhlZmZlY3QpO1xuICB9XG5cbiAgZnVuY3Rpb24gZGVzdHJveSgpIHtcbiAgICBzdG9yZS5kaXNwYXRjaCh7IHR5cGU6IGdldERlc3Ryb3lBY3Rpb25OYW1lKGNvbXBvbmVudElkKSB9KTtcbiAgICAvKipcbiAgICAgKiBBIHNlcnZpY2UgdGhhdCBleHRlbmRzIFRyYWl0c0xvY2FsU3RvcmUgYW5kIG90aGVyIGNvbXBvbmVudCBzZXJ2aWNlIGFyZSBkZXN0cm95ZWRcbiAgICAgKiBiZWZvcmUgdGhlIGNvbXBvbmVudCB0aGF0IGRlcGVuZHMgb24gdGhlbSwgdGhpcyBjYXVzZXMgdGhhdCBhbnkgc3Vic2NyaXB0aW9uc1xuICAgICAqIHRvIHNlbGVjdG9ycyBvZiB0aGUgVHJhaXRzTG9jYWxTdG9yZSBjb3VsZCBmYWlsIGJlY2F1c2UgdGhlIHN0b3JlIHN0YXRlIGlzIHJlbW92ZWQgYmVmb3JlXG4gICAgICogdGhleSBhcmUgdW5zdWJzY3JpYmUgYnkgdGhlIG9uRGVzdHJveSBvZiB0aGUgY29tcG9uZW50LiBFeGVjdXRpbmcgcmVkdWNlcnMucmVtb3ZlUmVkdWNlclxuICAgICAqIGluc2lkZSBzZXRUaW1lb3V0IGVuc3VyZXMgdGhlIHN0YXRlIGlzIHJlbW92ZSBhZnRlciB0aGUgY29tcG9uZW50IG9uRGVzdHJveSB3YXMgY2FsbGVkLFxuICAgICAqIGF2b2lkaW5nIHRoZSBiZWZvcmUgbWVudGlvbmVkIHBvc3NpYmxlIGlzc3Vlcy5cbiAgICAgKi9cbiAgICBzZXRUaW1lb3V0KCgpID0+IHJlZHVjZXJzLnJlbW92ZVJlZHVjZXIoY29tcG9uZW50SWQpKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZGVzdHJveSxcbiAgICAuLi50cmFpdHMsXG4gIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHlwZTxUPiBleHRlbmRzIEZ1bmN0aW9uIHtcbiAgbmV3ICguLi5hcmdzOiBhbnlbXSk6IFQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJhaXRMb2NhbEVmZmVjdHNGYWN0b3J5PEYgZXh0ZW5kcyBGZWF0dXJlRmFjdG9yeT4ge1xuICAoXG4gICAgYWxsQWN0aW9uczogUmV0dXJuVHlwZTxGPlsnYWN0aW9ucyddLFxuICAgIGFsbFNlbGVjdG9yczogUmV0dXJuVHlwZTxGPlsnc2VsZWN0b3JzJ10sXG4gICk6IFR5cGU8VHJhaXRFZmZlY3Q+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIExvY2FsVHJhaXRzQ29uZmlnPEYgZXh0ZW5kcyBGZWF0dXJlRmFjdG9yeT4ge1xuICBjb21wb25lbnROYW1lOiBzdHJpbmc7XG4gIHRyYWl0c0ZhY3Rvcnk6IEY7XG4gIGVmZmVjdEZhY3Rvcnk/OiBUcmFpdExvY2FsRWZmZWN0c0ZhY3Rvcnk8Rj47XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBUcmFpdHNMb2NhbFN0b3JlPEYgZXh0ZW5kcyBGZWF0dXJlRmFjdG9yeT4ge1xuICB0cmFpdHM6IFJldHVyblR5cGU8Rj4gJiB7IGRlc3Ryb3k6ICgpID0+IHZvaWQgfTtcblxuICBhY3Rpb25zOiBSZXR1cm5UeXBlPEY+WydhY3Rpb25zJ107XG4gIHNlbGVjdG9yczogUmV0dXJuVHlwZTxGPlsnc2VsZWN0b3JzJ107XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKHB1YmxpYyBpbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgICBjb25zdCBjb25maWcgPSB0aGlzLnNldHVwKCk7XG4gICAgdGhpcy50cmFpdHMgPSBidWlsZExvY2FsVHJhaXRzKFxuICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgIGNvbmZpZy5jb21wb25lbnROYW1lLFxuICAgICAgY29uZmlnLnRyYWl0c0ZhY3RvcnksXG4gICAgICBjb25maWcuZWZmZWN0RmFjdG9yeSxcbiAgICApO1xuICAgIHRoaXMuYWN0aW9ucyA9IHRoaXMudHJhaXRzLmFjdGlvbnM7XG4gICAgdGhpcy5zZWxlY3RvcnMgPSB0aGlzLnRyYWl0cy5zZWxlY3RvcnM7XG4gIH1cblxuICBhYnN0cmFjdCBzZXR1cCgpOiBMb2NhbFRyYWl0c0NvbmZpZzxGPjtcblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnRyYWl0cy5kZXN0cm95KCk7XG4gIH1cbn1cbiJdfQ==
