import { ChangeType } from '../crud/crud.model';
export function createCrudTraitMutators(allConfigs) {
  const { storeChanges } = allConfigs.crud || {};
  const adapter = allConfigs.loadEntities.adapter;
  function generateChangeEntry(entity, changeType, customId) {
    return {
      id:
        customId !== null && customId !== void 0
          ? customId
          : adapter.selectId(entity),
      changeType,
      entityChanges: (storeChanges && entity) || undefined,
    };
  }
  function add(entities, state, addFirst = false) {
    const changes = [
      ...state.changes,
      ...entities.map((entity) =>
        generateChangeEntry(entity, ChangeType.CREATED)
      ),
    ];
    if (!addFirst)
      return adapter.addMany(
        entities,
        Object.assign(Object.assign({}, state), { changes })
      );
    const newIds = entities.map((e) => adapter.selectId(e));
    const newEntities = Object.assign({}, state.entities);
    entities.forEach((e) => {
      const id = adapter.selectId(e);
      newEntities[id] = e;
    });
    return Object.assign(Object.assign({}, state), {
      ids: [...newIds, ...state.ids],
      entities: newEntities,
      changes,
    });
  }
  function upsert(entities, state) {
    const oldChanges = [...state.changes];
    const existingIds = adapter.getSelectors().selectIds(state);
    const [additions, updates] = entities.reduce(
      ([a, u], entity) =>
        existingIds.indexOf(adapter.selectId(entity)) !== -1
          ? [a, [...u, entity]]
          : [[...a, entity], u],
      [new Array(), new Array()]
    );
    return adapter.upsertMany(
      entities,
      Object.assign(Object.assign({}, state), {
        changes: [
          ...oldChanges,
          ...additions.map((entity) =>
            generateChangeEntry(entity, ChangeType.CREATED)
          ),
          ...updates.map((entity) =>
            generateChangeEntry(entity, ChangeType.UPDATED)
          ),
        ],
      })
    );
  }
  function remove(keysOrPredicate, state) {
    if (typeof keysOrPredicate === 'function') {
      return adapter.removeMany(
        keysOrPredicate,
        Object.assign(Object.assign({}, state), {
          changes: [
            ...state.changes,
            ...state.ids.map((id) => ({
              id,
              changeType: ChangeType.DELETED,
            })),
          ],
        })
      );
    }
    return adapter.removeMany(
      keysOrPredicate,
      Object.assign(Object.assign({}, state), {
        changes: [
          ...state.changes,
          ...keysOrPredicate.map((key) => ({
            id: key,
            changeType: ChangeType.DELETED,
          })),
        ],
      })
    );
  }
  function removeAll(state) {
    return adapter.removeAll(
      Object.assign(Object.assign({}, state), {
        changes: [
          ...state.changes,
          ...state.ids.map((id) => ({
            id,
            changeType: ChangeType.DELETED,
          })),
        ],
      })
    );
  }
  function clearChanges(state) {
    return Object.assign(Object.assign({}, state), { changes: [] });
  }
  function update(updates, state) {
    const oldChanges = [...state.changes];
    updates.forEach((updated) => {
      const id = adapter.selectId(updated.changes);
      if (id && id !== updated.id) {
        // if the id changes update the id of pold changes
        const index = oldChanges.findIndex((v) => v.id === updated.id);
        const oldChange = oldChanges[index];
        oldChanges[index] = Object.assign(Object.assign({}, oldChange), { id });
      }
    });
    return adapter.updateMany(
      updates,
      Object.assign(Object.assign({}, state), {
        changes: [
          ...oldChanges,
          ...updates.map((updated) => {
            var _a;
            return {
              id:
                (_a = adapter.selectId(updated.changes)) !== null &&
                _a !== void 0
                  ? _a
                  : updated.id,
              changeType: ChangeType.UPDATED,
              entityChanges: (storeChanges && updated.changes) || undefined,
            };
          }),
        ],
      })
    );
  }
  return {
    add,
    remove,
    update,
    removeAll,
    clearChanges,
    upsert,
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J1ZC50cmFpdC5tdXRhdG9ycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3RyYWl0cy9zcmMvY3J1ZC9jcnVkLnRyYWl0Lm11dGF0b3JzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxVQUFVLEdBSVgsTUFBTSxvQkFBb0IsQ0FBQztBQUk1QixNQUFNLFVBQVUsdUJBQXVCLENBQ3JDLFVBQTZEO0lBRTdELE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxVQUFVLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUMvQyxNQUFNLE9BQU8sR0FBRyxVQUFXLENBQUMsWUFBYSxDQUFDLE9BQU8sQ0FBQztJQUVsRCxTQUFTLG1CQUFtQixDQUMxQixNQUFjLEVBQ2QsVUFBc0IsRUFDdEIsUUFBMEI7UUFFMUIsT0FBTztZQUNMLEVBQUUsRUFBRSxRQUFRLGFBQVIsUUFBUSxjQUFSLFFBQVEsR0FBSSxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztZQUN4QyxVQUFVO1lBQ1YsYUFBYSxFQUFFLENBQUMsWUFBWSxJQUFJLE1BQU0sQ0FBQyxJQUFJLFNBQVM7U0FDckQsQ0FBQztJQUNKLENBQUM7SUFFRCxTQUFTLEdBQUcsQ0FDVixRQUFrQixFQUNsQixLQUFRLEVBQ1IsUUFBUSxHQUFHLEtBQUs7UUFFaEIsTUFBTSxPQUFPLEdBQUc7WUFDZCxHQUFHLEtBQUssQ0FBQyxPQUFPO1lBQ2hCLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQ3pCLG1CQUFtQixDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUMsT0FBTyxDQUFDLENBQ2hEO1NBQ0YsQ0FBQztRQUNGLElBQUksQ0FBQyxRQUFRO1lBQ1gsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsa0NBQzFCLEtBQUssS0FDUixPQUFPLElBQ1AsQ0FBQztRQUVMLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENB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LENBQUMsT0FBTyxrQ0FDNUIsS0FBSyxLQUNSLE9BQU8sRUFBRTtnQkFDUCxHQUFHLFVBQVU7Z0JBQ2IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUNaLENBQUMsT0FBTyxFQUFFLEVBQUU7O29CQUNWLE9BQUEsQ0FBQzt3QkFDQyxFQUFFLFFBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBaUIsQ0FBQyxtQ0FBSSxPQUFPLENBQUMsRUFBRTt3QkFDN0QsVUFBVSxFQUFFLFVBQVUsQ0FBQyxPQUFPO3dCQUM5QixhQUFhLEVBQUUsQ0FBQyxZQUFZLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLFNBQVM7cUJBQzNDLENBQUEsQ0FBQTtpQkFBQSxDQUN2QjthQUNGLElBQ0QsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPO1FBQ0wsR0FBRztRQUNILE1BQU07UUFDTixNQUFNO1FBQ04sU0FBUztRQUNULFlBQVk7UUFDWixNQUFNO0tBQ1AsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2UsXG4gIENoYW5nZVR5cGUsXG4gIENydWRLZXllZENvbmZpZyxcbiAgQ3J1ZE11dGF0b3JzLFxuICBFbnRpdHlBbmRDcnVkU3RhdGUsXG59IGZyb20gJy4uL2NydWQvY3J1ZC5tb2RlbCc7XG5pbXBvcnQgeyBQcmVkaWNhdGUsIFVwZGF0ZSB9IGZyb20gJ0BuZ3J4L2VudGl0eSc7XG5pbXBvcnQgeyBMb2FkRW50aXRpZXNLZXllZENvbmZpZyB9IGZyb20gJy4uL2xvYWQtZW50aXRpZXMvbG9hZC1lbnRpdGllcy5tb2RlbCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDcnVkVHJhaXRNdXRhdG9yczxFbnRpdHk+KFxuICBhbGxDb25maWdzOiBDcnVkS2V5ZWRDb25maWcgJiBMb2FkRW50aXRpZXNLZXllZENvbmZpZzxFbnRpdHk+LFxuKTogQ3J1ZE11dGF0b3JzPEVudGl0eT4ge1xuICBjb25zdCB7IHN0b3JlQ2hhbmdlcyB9ID0gYWxsQ29uZmlncy5jcnVkIHx8IHt9O1xuICBjb25zdCBhZGFwdGVyID0gYWxsQ29uZmlncyEubG9hZEVudGl0aWVzIS5hZGFwdGVyO1xuXG4gIGZ1bmN0aW9uIGdlbmVyYXRlQ2hhbmdlRW50cnkoXG4gICAgZW50aXR5OiBFbnRpdHksXG4gICAgY2hhbmdlVHlwZTogQ2hhbmdlVHlwZSxcbiAgICBjdXN0b21JZD86IHN0cmluZyB8IG51bWJlcixcbiAgKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiBjdXN0b21JZCA/PyBhZGFwdGVyLnNlbGVjdElkKGVudGl0eSksXG4gICAgICBjaGFuZ2VUeXBlLFxuICAgICAgZW50aXR5Q2hhbmdlczogKHN0b3JlQ2hhbmdlcyAmJiBlbnRpdHkpIHx8IHVuZGVmaW5lZCxcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gYWRkPFMgZXh0ZW5kcyBFbnRpdHlBbmRDcnVkU3RhdGU8RW50aXR5Pj4oXG4gICAgZW50aXRpZXM6IEVudGl0eVtdLFxuICAgIHN0YXRlOiBTLFxuICAgIGFkZEZpcnN0ID0gZmFsc2UsXG4gICkge1xuICAgIGNvbnN0IGNoYW5nZXMgPSBbXG4gICAgICAuLi5zdGF0ZS5jaGFuZ2VzLFxuICAgICAgLi4uZW50aXRpZXMubWFwKChlbnRpdHkpID0+XG4gICAgICAgIGdlbmVyYXRlQ2hhbmdlRW50cnkoZW50aXR5LCBDaGFuZ2VUeXBlLkNSRUFURUQpLFxuICAgICAgKSxcbiAgICBdO1xuICAgIGlmICghYWRkRmlyc3QpXG4gICAgICByZXR1cm4gYWRhcHRlci5hZGRNYW55KGVudGl0aWVzLCB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBjaGFuZ2VzLFxuICAgICAgfSk7XG5cbiAgICBjb25zdCBuZXdJZHMgPSBlbnRpdGllcy5tYXAoKGUpID0+IGFkYXB0ZXIuc2VsZWN0SWQoZSkpO1xuICAgIGNvbnN0IG5ld0VudGl0aWVzID0geyAuLi5zdGF0ZS5lbnRpdGllcyB9O1xuICAgIGVudGl0aWVzLmZvckVhY2goKGUpID0+IHtcbiAgICAgIGNvbnN0IGlkID0gYWRhcHRlci5zZWxlY3RJZChlKTtcbiAgICAgIG5ld0VudGl0aWVzW2lkXSA9IGU7XG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgaWRzOiBbLi4ubmV3SWRzLCAuLi5zdGF0ZS5pZHNdLFxuICAgICAgZW50aXRpZXM6IG5ld0VudGl0aWVzLFxuICAgICAgY2hhbmdlcyxcbiAgICB9O1xuICB9XG5cbiAgZnVuY3Rpb24gdXBzZXJ0PFMgZXh0ZW5kcyBFbnRpdHlBbmRDcnVkU3RhdGU8RW50aXR5Pj4oXG4gICAgZW50aXRpZXM6IEVudGl0eVtdLFxuICAgIHN0YXRlOiBTLFxuICApIHtcbiAgICBjb25zdCBvbGRDaGFuZ2VzID0gWy4uLnN0YXRlLmNoYW5nZXNdO1xuICAgIGNvbnN0IGV4aXN0aW5nSWRzID0gYWRhcHRlci5nZXRTZWxlY3RvcnMoKS5zZWxlY3RJZHMoc3RhdGUpIGFzIHN0cmluZ1tdO1xuXG4gICAgY29uc3QgW2FkZGl0aW9ucywgdXBkYXRlc10gPSBlbnRpdGllcy5yZWR1Y2UoXG4gICAgICAoW2EsIHVdLCBlbnRpdHkpID0+XG4gICAgICAgIGV4aXN0aW5nSWRzLmluZGV4T2YoYWRhcHRlci5zZWxlY3RJZChlbnRpdHkgYXMgRW50aXR5KSBhcyBzdHJpbmcpICE9PSAtMVxuICAgICAgICAgID8gW2EsIFsuLi51LCBlbnRpdHldXVxuICAgICAgICAgIDogW1suLi5hLCBlbnRpdHldLCB1XSxcbiAgICAgIFtuZXcgQXJyYXk8RW50aXR5PigpLCBuZXcgQXJyYXk8RW50aXR5PigpXSxcbiAgICApO1xuXG4gICAgcmV0dXJuIGFkYXB0ZXIudXBzZXJ0TWFueShlbnRpdGllcywge1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBjaGFuZ2VzOiBbXG4gICAgICAgIC4uLm9sZENoYW5nZXMsXG5cbiAgICAgICAgLi4uYWRkaXRpb25zLm1hcCgoZW50aXR5KSA9PlxuICAgICAgICAgIGdlbmVyYXRlQ2hhbmdlRW50cnkoZW50aXR5LCBDaGFuZ2VUeXBlLkNSRUFURUQpLFxuICAgICAgICApLFxuICAgICAgICAuLi51cGRhdGVzLm1hcCgoZW50aXR5KSA9PlxuICAgICAgICAgIGdlbmVyYXRlQ2hhbmdlRW50cnkoZW50aXR5LCBDaGFuZ2VUeXBlLlVQREFURUQpLFxuICAgICAgICApLFxuICAgICAgXSxcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHJlbW92ZTxTIGV4dGVuZHMgRW50aXR5QW5kQ3J1ZFN0YXRlPEVudGl0eT4+KFxuICAgIGtleXM6IG51bWJlcltdLFxuICAgIHN0YXRlOiBTLFxuICApOiBTO1xuICBmdW5jdGlvbiByZW1vdmU8UyBleHRlbmRzIEVudGl0eUFuZENydWRTdGF0ZTxFbnRpdHk+PihcbiAgICBrZXlzOiBzdHJpbmdbXSxcbiAgICBzdGF0ZTogUyxcbiAgKTogUztcbiAgZnVuY3Rpb24gcmVtb3ZlPFMgZXh0ZW5kcyBFbnRpdHlBbmRDcnVkU3RhdGU8RW50aXR5Pj4oXG4gICAgcHJlZGljYXRlOiBQcmVkaWNhdGU8RW50aXR5PixcbiAgICBzdGF0ZTogUyxcbiAgKTogUztcbiAgZnVuY3Rpb24gcmVtb3ZlPFMgZXh0ZW5kcyBFbnRpdHlBbmRDcnVkU3RhdGU8RW50aXR5Pj4oXG4gICAga2V5c09yUHJlZGljYXRlOiBQcmVkaWNhdGU8RW50aXR5PiB8IHN0cmluZ1tdIHwgbnVtYmVyW10sXG4gICAgc3RhdGU6IFMsXG4gICk6IFMge1xuICAgIGlmICh0eXBlb2Yga2V5c09yUHJlZGljYXRlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICByZXR1cm4gYWRhcHRlci5yZW1vdmVNYW55KGtleXNPclByZWRpY2F0ZSwge1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgY2hhbmdlczogW1xuICAgICAgICAgIC4uLnN0YXRlLmNoYW5nZXMsXG4gICAgICAgICAgLi4uKHN0YXRlLmlkcyBhcyBhbnlbXSkubWFwKChpZCkgPT4gKHtcbiAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgY2hhbmdlVHlwZTogQ2hhbmdlVHlwZS5ERUxFVEVELFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgXSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBhZGFwdGVyLnJlbW92ZU1hbnkoa2V5c09yUHJlZGljYXRlIGFzIHN0cmluZ1tdLCB7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGNoYW5nZXM6IFtcbiAgICAgICAgLi4uc3RhdGUuY2hhbmdlcyxcbiAgICAgICAgLi4uKGtleXNPclByZWRpY2F0ZSBhcyBzdHJpbmdbXSkubWFwKChrZXk6IHN0cmluZykgPT4gKHtcbiAgICAgICAgICBpZDoga2V5LFxuICAgICAgICAgIGNoYW5nZVR5cGU6IENoYW5nZVR5cGUuREVMRVRFRCxcbiAgICAgICAgfSkpLFxuICAgICAgXSxcbiAgICB9KTtcbiAgfVxuICBmdW5jdGlvbiByZW1vdmVBbGw8UyBleHRlbmRzIEVudGl0eUFuZENydWRTdGF0ZTxFbnRpdHk+PihzdGF0ZTogUyk6IFMge1xuICAgIHJldHVybiBhZGFwdGVyLnJlbW92ZUFsbCh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGNoYW5nZXM6IFtcbiAgICAgICAgLi4uc3RhdGUuY2hhbmdlcyxcbiAgICAgICAgLi4uKHN0YXRlLmlkcyBhcyBhbnlbXSkubWFwKChpZCkgPT4gKHtcbiAgICAgICAgICBpZCxcbiAgICAgICAgICBjaGFuZ2VUeXBlOiBDaGFuZ2VUeXBlLkRFTEVURUQsXG4gICAgICAgIH0pKSxcbiAgICAgIF0sXG4gICAgfSk7XG4gIH1cbiAgZnVuY3Rpb24gY2xlYXJDaGFuZ2VzPFMgZXh0ZW5kcyBFbnRpdHlBbmRDcnVkU3RhdGU8RW50aXR5Pj4oc3RhdGU6IFMpIHtcbiAgICByZXR1cm4geyAuLi5zdGF0ZSwgY2hhbmdlczogW10gfTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHVwZGF0ZTxTIGV4dGVuZHMgRW50aXR5QW5kQ3J1ZFN0YXRlPEVudGl0eT4+KFxuICAgIHVwZGF0ZXM6IFVwZGF0ZTxFbnRpdHk+W10sXG4gICAgc3RhdGU6IFMsXG4gICkge1xuICAgIGNvbnN0IG9sZENoYW5nZXMgPSBbLi4uc3RhdGUuY2hhbmdlc107XG4gICAgdXBkYXRlcy5mb3JFYWNoKCh1cGRhdGVkKSA9PiB7XG4gICAgICBjb25zdCBpZCA9IGFkYXB0ZXIuc2VsZWN0SWQodXBkYXRlZC5jaGFuZ2VzIGFzIEVudGl0eSk7XG4gICAgICBpZiAoaWQgJiYgaWQgIT09IHVwZGF0ZWQuaWQpIHtcbiAgICAgICAgLy8gaWYgdGhlIGlkIGNoYW5nZXMgdXBkYXRlIHRoZSBpZCBvZiBwb2xkIGNoYW5nZXNcbiAgICAgICAgY29uc3QgaW5kZXggPSBvbGRDaGFuZ2VzLmZpbmRJbmRleCgodikgPT4gdi5pZCA9PT0gdXBkYXRlZC5pZCk7XG4gICAgICAgIGNvbnN0IG9sZENoYW5nZSA9IG9sZENoYW5nZXNbaW5kZXhdO1xuICAgICAgICBvbGRDaGFuZ2VzW2luZGV4XSA9IHsgLi4ub2xkQ2hhbmdlLCBpZCB9O1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBhZGFwdGVyLnVwZGF0ZU1hbnkodXBkYXRlcywge1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBjaGFuZ2VzOiBbXG4gICAgICAgIC4uLm9sZENoYW5nZXMsXG4gICAgICAgIC4uLnVwZGF0ZXMubWFwKFxuICAgICAgICAgICh1cGRhdGVkKSA9PlxuICAgICAgICAgICAgKHtcbiAgICAgICAgICAgICAgaWQ6IGFkYXB0ZXIuc2VsZWN0SWQodXBkYXRlZC5jaGFuZ2VzIGFzIEVudGl0eSkgPz8gdXBkYXRlZC5pZCxcbiAgICAgICAgICAgICAgY2hhbmdlVHlwZTogQ2hhbmdlVHlwZS5VUERBVEVELFxuICAgICAgICAgICAgICBlbnRpdHlDaGFuZ2VzOiAoc3RvcmVDaGFuZ2VzICYmIHVwZGF0ZWQuY2hhbmdlcykgfHwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgfSBhcyBDaGFuZ2U8RW50aXR5PiksXG4gICAgICAgICksXG4gICAgICBdLFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBhZGQsXG4gICAgcmVtb3ZlLFxuICAgIHVwZGF0ZSxcbiAgICByZW1vdmVBbGwsXG4gICAgY2xlYXJDaGFuZ2VzLFxuICAgIHVwc2VydCxcbiAgfTtcbn1cbiJdfQ==
